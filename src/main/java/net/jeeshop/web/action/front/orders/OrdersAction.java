package net.jeeshop.web.action.front.orders;import java.text.DecimalFormat;import java.util.HashMap;import java.util.LinkedList;import java.util.List;import java.util.Map;import net.jeeshop.core.BaseAction;import net.jeeshop.core.FrontContainer;import net.jeeshop.core.kuaidi100Helper;import net.jeeshop.core.dao.page.PagerModel;import net.jeeshop.core.front.SystemManager;import net.jeeshop.services.front.account.bean.Account;import net.jeeshop.services.front.address.AddressService;import net.jeeshop.services.front.address.bean.Address;import net.jeeshop.services.front.area.bean.Area;import net.jeeshop.services.front.comment.CommentService;import net.jeeshop.services.front.comment.bean.Comment;import net.jeeshop.services.front.express.bean.Express;import net.jeeshop.services.front.order.OrderService;import net.jeeshop.services.front.order.bean.Order;import net.jeeshop.services.front.orderdetail.OrderdetailService;import net.jeeshop.services.front.orderdetail.bean.Orderdetail;import net.jeeshop.services.front.orderpay.OrderpayService;import net.jeeshop.services.front.orderpay.bean.Orderpay;import net.jeeshop.services.front.ordership.OrdershipService;import net.jeeshop.services.front.ordership.bean.Ordership;import net.jeeshop.services.front.product.ProductService;import net.jeeshop.services.front.product.bean.Product;import net.jeeshop.services.front.product.bean.ProductStockInfo;import org.apache.commons.lang.StringUtils;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.annotation.Scope;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.ModelAttribute;import org.springframework.web.bind.annotation.RequestMapping;/** * 门户订单服务类 *  * @author Administrator *  */@Scope("prototype")   @Controller("frontOrdersAction")   @RequestMapping("/orders")public class OrdersAction extends BaseAction<Order> {	private static final Logger logger = LoggerFactory.getLogger(OrdersAction.class);	private static final long serialVersionUID = 1L;	@Autowired	private OrderService orderService;	@Autowired	private OrderdetailService orderdetailService;	@Autowired	private OrderpayService orderpayService;	@Autowired	private ProductService productService;	@Autowired	private CommentService commentService;	@Autowired	private OrdershipService ordershipService;	@Autowired	private AddressService addressService;		private final static String toLogin = "/user/login";	private final static String toPay = "alipayapi";	private final static String rate = "rate";	private final static String pay_success = "pay_success";	private final static String doPay = "redirect:doPay.jsp";	private final static String orderInfo = "/user/orderInfo";	private final static String orderhipInfo = "/user/orderhipInfo";	private final static String confirmOrder = "/confirmOrder";	private final static String paySuccess = "/paySuccess";	private final static String thinksRate = "/thinksRate";	private final static String result_myOrders = "/user/myOrders";			@ModelAttribute	public void initStrutsActionParam(){		this.server = orderService ;	}		private List<Order> myOrders;	private Map<String, Order> orderMap;//	private boolean is_test = false;//是否是测试状态	private Product product;//用户进行评论时加载的商品信息	private Comment comment;//用户是否进行过评价；如果此对象不为空，则用户进行过评价		private String selectLeftMenu;//选中的个人中心的菜单项		public String getSelectLeftMenu() {		return selectLeftMenu;	}	public void setSelectLeftMenu(String selectLeftMenu) {		this.selectLeftMenu = selectLeftMenu;	}	public Comment getComment() {		return comment;	}	public void setComment(Comment comment) {		this.comment = comment;	}	public Product getProduct() {		return product;	}	public void setProduct(Product product) {		this.product = product;	}	public Map<String, Order> getOrderMap() {		return orderMap;	}	public void setOrderMap(Map<String, Order> orderMap) {		this.orderMap = orderMap;	}	public List<Order> getMyOrders() {		return myOrders;	}	public void setMyOrders(List<Order> myOrders) {		this.myOrders = myOrders;	}	public OrderService getOrderService() {		return orderService;	}	public void setOrderService(OrderService orderService) {		this.orderService = orderService;	}	protected void selectListAfter() {		pager.setPagerUrl("myOrders.html");	}	public Order getE() {		return this.e;	}	public void prepare() throws Exception {		if (this.e == null) {			this.e = new Order();		}		if(orderMap==null){			orderMap = new HashMap<String, Order>();		}		if(this.comment==null){			this.comment = new Comment();		}		super.setSelectMenu(FrontContainer.not_select_menu);//设置主菜单为不选中	}		public void insertAfter(Order e) {		e.clear();	}	/**	 * 订单确认页面，点击这个页面的确认支付按钮则会跳转到支付宝等的支付页面	 * 	 * @return	 */	public String orderComfig() {		return "orderComfig";	}		@RequestMapping("/pay")	public String pay() throws Exception{		return insertAndPay();	}	/**	 * 创建订单，并跳转到支付页面让用户进行支付	 * 	 * @return	 * @throws Exception	 */	private String insertAndPay() throws Exception {//		if(!TokenUtil.getInstance().isTokenValid(request)){//			throw new Exception("表单重复提交了！");//		}				logger.error("==insertAndPay=="+e.getSelectAddressID()+",expressCode = "+e.getExpressCode()+",otherRequirement = " + e.getOtherRequirement());		Account account = (Account) getSession().getAttribute(FrontContainer.USER_INFO);		if (account == null || StringUtils.isBlank(account.getAccount())) {			return "toLogin";		}				if(StringUtils.isBlank(e.getSelectAddressID()) || StringUtils.isBlank(e.getExpressCode())){			throw new NullPointerException("非法请求！");		}		//从session中获取用户购买的商品列表		CartInfo cartInfo = (CartInfo) getSession().getAttribute(FrontContainer.myCart);		if (cartInfo == null || cartInfo.getProductList().size() == 0) {			throw new NullPointerException("购物车中没有可支付的商品!");		}				//检测商品是否都有库存,如果没有库存需要提醒用户		synchronized (SystemManager.product_stock_lock) {			boolean no = false;			for (int i = 0; i < cartInfo.getProductList().size(); i++) {				Product product = cartInfo.getProductList().get(i);				if(SystemManager.productStockMap.get(product.getId())==null){					product.product_sorry_str = "抱歉，该商品目前库存不足！";					no = true;					continue;				}								ProductStockInfo stockInfo = SystemManager.productStockMap.get(product.getId());				if(product.getBuyCount() > stockInfo.getStock()){					//如果用户购买的某个商品的数量大于该商品的库存数，则提示					product.product_sorry_str = "抱歉，该商品目前库存不足！";					no = true;				}			}						//库存不足，则刷最后支付页面，提示用户某些商品的库存不足，请重新选购			if(no){				logger.error("某些商品库存不足！请重新选购！");				response.sendRedirect("confirmOrder.html");				return null;			}			//			if(!no){//				//如果检查没有出现库存不足的情况，则进行砍库存操作//				for (int i = 0; i < cartInfo.getProductList().size(); i++) {//					Product product = cartInfo.getProductList().get(i);//					ProductStockInfo stockInfo = SystemManager.productStockMap.get(product.getId());//					stockInfo.setStock(stockInfo.getStock() - product.getBuyCount());//					stockInfo.setChangeStock(true);//					SystemManager.productStockMap.put(product.getId(),stockInfo);//				}//			}		}				//获取配送方式		Express express = SystemManager.expressMap.get(e.getExpressCode());		if(express==null){			throw new NullPointerException("没有编码为"+e.getExpressCode()+"的配送方式！本次请求视为非法！");		}				//创建订单对象		Order order = new Order();		order.setAccount(account.getAccount());		order.setQuantity(cartInfo.getProductList().size());		order.setRebate(1);		order.setStatus(Order.order_status_init);		order.setPaystatus(Order.order_paystatus_n);		order.setOtherRequirement(e.getOtherRequirement());//附加要求				//商品总金额//		double ptotal = 0d;		int score = 0;//订单积分 等于订单项中每个商品赠送的积分总和		//创建订单明细集合		List<Orderdetail> orderdetailList = new LinkedList<Orderdetail>();		for (int i = 0; i < cartInfo.getProductList().size(); i++) {			Product product = cartInfo.getProductList().get(i);			//			ProductStockInfo momeryProduct = SystemManager.productStockMap.get(product.getId());//			if(StringUtils.isNotBlank(momeryProduct.getActivityID())){//				Activity activity = SystemManager.activityMap.get(momeryProduct.getActivityID());//				String discountType = activity.getDiscountType();//				if(discountType.equals(Activity.activity_discountType_r)){//					////					double finalPrice = Double.valueOf(product.getNowPrice()) - Double.valueOf(activity.getDiscount());//					//				}else if(discountType.equals(Activity.activity_discountType_d)){//					//				}//			}						Orderdetail orderdetail = new Orderdetail();			orderdetail.setProductID(Integer.valueOf(product.getId()));			orderdetail.setGiftID(product.getGiftID());//商品赠品ID			orderdetail.setPrice(product.getNowPrice());//商品现价			orderdetail.setNumber(product.getBuyCount());//购买数			orderdetail.setFee("0");//配送费			orderdetail.setProductName(product.getName());			orderdetail.setTotal0(String.valueOf(Double.valueOf(orderdetail.getPrice()) * orderdetail.getNumber()));//订单项小计			orderdetail.setScore(product.getScore());//活的赠送的积分			if(product.getBuySpecInfo()!=null){				//按照规格计算				orderdetail.setSpecInfo("尺寸:"+product.getBuySpecInfo().getSpecSize()+",颜色:"+product.getBuySpecInfo().getSpecColor());//				ptotal+= Double.valueOf(product.getBuySpecInfo().getSpecPrice()) * product.getBuyCount();//				score+= product.getScore();			}else{			}//			ptotal+= Double.valueOf(product.getNowPrice()) * product.getBuyCount();			score+= product.getScore();			orderdetailList.add(orderdetail);		}		if(orderdetailList.size()==1){			order.setRemark(orderdetailList.get(0).getProductName());		}else{			order.setRemark("合并|"+orderdetailList.size()+"笔订单");		}				order.setScore(score);		order.setExpressCode(express.getCode());//配送方式编码		order.setExpressName(express.getName());//配送方式名称		order.setFee(String.valueOf(express.getFee()));//订单配送费		order.setPtotal(cartInfo.getAmount());//订单商品总金额		order.setAmount(String.valueOf(Double.valueOf(cartInfo.getAmount())+Double.valueOf(order.getFee())));//订单总金额 = 内存订单总金额 + 总配送费		order.setAmountExchangeScore(cartInfo.getTotalExchangeScore());//订单总兑换积分。订单支付成功以后扣除				/**		 * 对金额进行格式化，防止出现double型数字计算造成的益出。		 */		logger.error("order.getAmount()="+order.getAmount());		order.setAmount(df.format(Double.valueOf(order.getAmount())));//订单总金额		order.setPtotal(df.format(Double.valueOf(order.getPtotal())));//订单商品总金额		order.setFee(df.format(Double.valueOf(order.getFee())));//订单总配送费				/**		 * 配送地址信息		 */		Ordership ordership = new Ordership();		ordership.setOrderid(order.getId());				Address address = addressService.selectById(e.getSelectAddressID());		if(address==null){			throw new NullPointerException("根据ID="+e.getSelectAddressID()+"查询不到配送地址信息！本次请求视为非法！");		}		logger.error(address.toString());				Area area = SystemManager.areaMap.get(address.getProvince());//获取省份对象		String proinceName = area.getName();//省份名称		String cityName = null;//城市名称		String areaName = null;		List<Area> citys = area.getChildren();		if(citys!=null && citys.size()>0){			for(int i=0;i<citys.size();i++){				Area cityItem = citys.get(i);				if(cityItem.getCode().equals(address.getCity())){					cityName = cityItem.getName();										//获取所在区域名称					if(StringUtils.isNotBlank(address.getArea())){						List<Area> areaList = cityItem.getChildren();						if(areaList!=null && areaList.size()>0){							for(int m=0;m<areaList.size();m++){								areaName = areaList.get(m).getName();							}						}					}				}			}		}		ordership.setShipname(address.getName());		ordership.setShipaddress(proinceName+cityName+address.getAddress());		ordership.setProvinceCode(address.getProvince());		ordership.setProvince(proinceName);		ordership.setCityCode(address.getCity());		ordership.setCity(cityName);		ordership.setAreaCode(address.getArea());		ordership.setArea(areaName);		ordership.setPhone(address.getPhone());		ordership.setTel(address.getMobile());		ordership.setZip(address.getZip());		ordership.setSex("1");		logger.error(ordership.toString());				//创建订单并插入到数据库		orderService.createOrder(order, orderdetailList,ordership);				createPayInfo(order,ordership);				//清空购物车		cartInfo.clear();		cartInfo = null;		getSession().setAttribute(FrontContainer.myCart,null);				//更新内存中的订单缓存数据//		if(SystemManager.ordersReport!=null){//			SystemManager.ordersReport.setNotPayCount(SystemManager.ordersReport.getNotPayCount()+1);//订单++////			SystemManager.ordersReport.getNotPayCount().incrementAndGet();//订单++//		}				return toPay;	}		/**	 * 点击我的订单页面的未付款的订单进行付款操作,则跳转到付款页面进行付款	 * @return	 */	@RequestMapping("/toPay")	public String toPay(){		if (getSession().getAttribute(FrontContainer.USER_INFO) == null) {			return "toLogin";		}		String orderid = request.getParameter("id");		logger.error("orderid="+orderid);		if(StringUtils.isBlank(orderid)){			throw new NullPointerException();		}				Order order = orderService.selectById(orderid);		if(order==null){			throw new NullPointerException("根据订单号查询不到订单信息！");		}				Ordership ordership = ordershipService.selectOne(new Ordership(orderid));		if(ordership==null){			throw new NullPointerException("根据订单号查询不到配送信息！");		}				//创建支付记录对象		Orderpay orderpay = new Orderpay();		orderpay.setOrderid(orderid);		orderpay.setPaystatus(Orderpay.orderpay_paystatus_n);				orderpay.setPayamount(Double.valueOf(order.getAmount()));		orderpay.setPaymethod(Orderpay.orderpay_paymethod_alipayescow);		int orderpayID = orderpayService.insert(orderpay);		logger.error("orderpayID="+orderpayID);				order.setOrderpayID(String.valueOf(orderpayID));				//查询配送地址信息		createPayInfo(order,ordership);		return toPay;	}		/**	 * 用户进行评论提交	 * @return	 * @throws Exception 	 */	@RequestMapping("/doRate")	public String doRate() throws Exception{		Account acc = (Account) getSession().getAttribute(FrontContainer.USER_INFO);		if (acc == null) {			response.getWriter().write("-1");			return null;		}		logger.error("doRate...");				int orderid = Integer.valueOf(request.getParameter("orderid").toString());		Order order = orderService.selectById(String.valueOf(orderid));		if (StringUtils.isNotBlank(order.getClosedComment())				&& order.getClosedComment().equals(Order.order_closedComment_y)) {			//订单的点评功能已被关闭。			throw new RuntimeException(FrontContainer.request_illegal_error);		}				/*		 * 用户可以对每个订单项对应的商品进行评价		 */		Orderdetail orderdetail = new Orderdetail();		orderdetail.setOrderID(orderid);		List<Orderdetail> list = orderdetailService.selectList(orderdetail);		List<Comment> comments = new LinkedList<Comment>();		for(int i=0;i<list.size();i++){			Orderdetail item = list.get(i);			//获取页面上填写的评论类容			String content = request.getParameter("product_"+item.getProductID());			if(StringUtils.isBlank(content)){				continue;			}			Comment c = new Comment();			c.setProductID(String.valueOf(item.getProductID()));			c.setOrderdetailID(item.getId());			c.setOrderID(String.valueOf(orderid));			c.setContent(content);			c.setStatus(Comment.comment_status_y);			c.setNickname(acc.getNickname());			c.setStar(5);			c.setAccount(acc.getAccount());			comments.add(c);		}		commentService.insertList(comments);		response.sendRedirect("thinksRate.html");		return null;	}		@RequestMapping("/thinksRate")	public String thinksRate(){		logger.error("thinksRate...");		return thinksRate;	}		/**	 * 支付成功后进行评价,转到评论页面	 * @return	 * @throws Exception 	 */	@RequestMapping("/rate")	public String rate() throws Exception{		Account acc = (Account)getSession().getAttribute(FrontContainer.USER_INFO);		if (acc == null) {			return "toLogin";		}		getSession().setAttribute(FrontContainer.selectMenu, FrontContainer.not_select_menu);//		String productID = request.getParameter("productID");		String orderid = request.getParameter("orderid");		if(StringUtils.isBlank(orderid)){			throw new NullPointerException("参数异常！");		}				/*		 * 用户可以对每个订单项对应的商品进行评价		 */		Orderdetail orderdetail = new Orderdetail();		orderdetail.setOrderID(Integer.valueOf(orderid));		orderdetail.setIsComment(Orderdetail.orderdetail_isComment_n);		e.setRateOrderdetailList(orderdetailService.selectList(orderdetail));		e.setId(orderid);		if(e.getRateOrderdetailList()!=null && e.getRateOrderdetailList().size()==0){			e.setRateOrderdetailList(null);		}				//加载商品信息//		product = productService.selectById(productID);//		//加载以往用户的评价信息//		comment.clear();//		comment.setAccount(acc.getAccount());//		comment.setProductID(Integer.valueOf(productID));//		comment.setOrderID(Integer.valueOf(orderid));//		comment = commentService.selectOne(comment);//		if(comment==null){//			logger.error("还没有评价");//		}else{//			logger.error("已经评价过了");//		}				//加载指定商品的评论列表//		Comment commentParam = new Comment();//		commentParam.setProductID(Integer.valueOf(productID));//		selectCommentList(commentParam);		return rate;	}		/**	 * 分页加载评论	 * @return	 * @throws Exception	 */	private void selectCommentList(Comment commentParam) throws Exception {		int offset = 0;		if (request.getParameter("pager.offset") != null) {			offset = Integer					.parseInt(request.getParameter("pager.offset"));		}		if (offset < 0)			offset = 0;//		Comment comment = new Comment();		((PagerModel) commentParam).setOffset(offset);		pager = commentService.selectPageList(commentParam);		if(pager==null)pager = new PagerModel();		// 计算总页数		pager.setPagerSize((pager.getTotal() + pager.getPageSize() - 1)				/ pager.getPageSize());		//		selectListAfter();		pager.setPagerUrl("rate.html");	}		DecimalFormat df = new DecimalFormat("0.00");	/**	 * 创建支付宝的付款信息对象	 * @param order	 */	private void createPayInfo(Order order,Ordership ordership) {		if(order==null || ordership==null){			throw new NullPointerException("参数不能为空！请求非法！");		}				PayInfo payInfo = new PayInfo();		payInfo.setWIDseller_email(ordership.getPhone());//		String debug = SystemManager.getInstance().get("system_debug");		String www = SystemManager.systemSetting.getWww();		/**		 * 解决由于本地和线上正式环境提交相同的商户订单号导致支付宝出现TRADE_DATA_MATCH_ERROR错误的问题。		 * 本地提交的商户订单号前缀是test开头，正式环境提交的就是纯粹的支付订单号		 */		if(www.startsWith("http://127.0.0.1") || www.startsWith("http://localhost")){			payInfo.setWIDout_trade_no("test"+order.getOrderpayID());		}else{			payInfo.setWIDout_trade_no(order.getOrderpayID());		}		payInfo.setWIDsubject(order.getProductName());				payInfo.setWIDprice(Double.valueOf(order.getPtotal()));		payInfo.setWIDbody(order.getRemark());//		payInfo.setShow_url(SystemManager.systemSetting.getWww()+"/product/"+payInfo.getWIDout_trade_no()+".html");		payInfo.setShow_url(SystemManager.systemSetting.getWww()+"/order/orderInfo.html?id="+order.getId());		payInfo.setWIDreceive_name(ordership.getShipname());		payInfo.setWIDreceive_address(ordership.getShipaddress());		payInfo.setWIDreceive_zip(ordership.getZip());		payInfo.setWIDreceive_phone(ordership.getTel());		payInfo.setWIDreceive_mobile(ordership.getPhone());		payInfo.setWIDsubject(order.getRemark());				payInfo.setLogistics_fee(Double.valueOf(order.getFee()));		payInfo.setLogistics_type(order.getExpressCode());				logger.error(payInfo.toString());		request.setAttribute("payInfo", payInfo);	}		/**	 * 查询我的订单列表信息	 */	public String selectList() throws Exception {		return super.selectList();	}	/**	 * 删除我的订单信息	 */	public String deletes() throws Exception {		return super.deletes();	}		/**	 * 退订或取消指定的订单	 * @return	 * @throws Exception	 */	public String cancel() throws Exception {		return "";	}		/**	 * 读取指定订单的信息	 * @return	 */	public String read(){				return "";	}		/**	 * 对指定的订单进行支付	 * @return	 *///	public String doPay(){//		if(1==1){//			throw new NullPointerException();//		}//		//		String orderID = request.getParameter("orderID");//		e.clear();//		e.setId(orderID);//		e.setStatus(Order.order_status_init);//等待付款//		logger.error("orderid=" + orderID);//		orderService.update(e);//		return "doPay";//	}		/**	 * 查看订单详情	 * @return	 */	@RequestMapping("/orderInfo")	public String orderInfo(){		Account acc = (Account) getSession().getAttribute(FrontContainer.USER_INFO);		if (acc == null) {			return toLogin;		}		logger.error("orderInfo...");		String id = request.getParameter("id");		if(StringUtils.isBlank(id)){			throw new NullPointerException("订单ID不能为空！");		}				//查询订单信息		Order order = new Order();		order.setId(id);		order.setAccount(acc.getAccount());		List<Order> orders = orderService.selectOrderInfo(order);		if(orders==null || orders.size()==0){			throw new NullPointerException("根据订单ID查询不到订单信息！");		}		logger.error("orders.size="+orders.size());		e = orders.get(0);		e.setOrders(orders);		//查询订单配送信息		Ordership ordership = new Ordership();		ordership.setOrderid(id);		ordership = ordershipService.selectOne(ordership);		if(ordership==null){			throw new NullPointerException("根据订单ID查询不到订单配送信息！");		}		e.setOrdership(ordership);				//查询订单物流信息		e.setKuaid100Info(kuaidi100Helper.selectKuaidi100());		selectLeftMenu = "orders";		return orderInfo;	}		/**	 * 查看物流信息	 * @return	 */	@RequestMapping("/orderhipInfo")	public String orderhipInfo(){		logger.error("orderhipInfo...");		return orderhipInfo;	}	/**	 * 确认订单信息	 * @return	 */	@RequestMapping("/confirmOrder")	public String confirmOrder(){		logger.error("confirmOrder..");		Account acc = (Account) getSession().getAttribute(FrontContainer.USER_INFO);		if (acc == null || StringUtils.isBlank(acc.getAccount())) {//			getSession().getAttribute(FrontContainer);			return toLogin;		}				//检查购买的商品是否超出可购买的库存数		CartInfo cartInfo = (CartInfo)getSession().getAttribute(FrontContainer.myCart);		if(cartInfo==null){			throw new NullPointerException("非法请求");		}				for(int i=0;i<cartInfo.getProductList().size();i++){			Product product = cartInfo.getProductList().get(i);			ProductStockInfo stockInfo = SystemManager.productStockMap.get(product.getId());			if(stockInfo==null){				//商品已卖完或已下架，请联系站点管理员!				throw new RuntimeException("商品已卖完或已下架，请联系站点管理员!");			}else if(stockInfo.getStock() < product.getBuyCount()){				//购买的商品数超出库存数				throw new RuntimeException("商品已卖完或已下架，请联系站点管理员!");			}		}				//加载配送信息		Address add = new Address();		add.setAccount(acc.getAccount());		List<Address> addressList = addressService.selectList(add);		cartInfo.setAddressList(addressList);		if(addressList!=null && addressList.size()>0){//			boolean exist = false;			for(int i=0;i<addressList.size();i++){				Address addItem = addressList.get(i);				if(StringUtils.isNotBlank(addItem.getIsdefault()) && addItem.getIsdefault().equals("y")){					cartInfo.setDefaultAddessID(addItem.getId());					break;				}			}		}		return confirmOrder;	}		/**	 * 支付成功后，回调请求跳转到的页面	 * @return	 */	@RequestMapping("/paySuccess")	public String paySuccess(){		logger.error("paySuccess...");		return paySuccess;	}}